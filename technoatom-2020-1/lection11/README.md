# Итоговый проект


## Тестируемое приложение
* Приложение представляет собой простую страничку-визитку с формой авторизации и возможностью зарегистрировать
нового пользователя. Так же есть поддержка управления пользователями через API.

* Приложение поставляется в docker-контейнере и может быть запущено только в нем.

* Приложение для своей работы обязательно требует базу данных MySQL.

* Приложение упаковано в бинарь и не предполагает возможность получить исходники через декомпиляцию итд.

* В приложении предусмотрены баги.

## Подробное описание приложения
### Страница авторизации
Содержит 2 поля для ввода (логин и пароль), а так же кнопку авторизации.
Содержит кнопку для регистрации.

У всех полей присутствует валидация.

По нажатию на кнопку входа - проверяет авторизационные данные, и, если они верны - пропускает на главную страничку,
иначе выдает ошибку.

Авторизация должна работать корректно, а именно:
* валидный пользователь успешно авторизовывается
* невалидный пользователь не авторизовывается и отображается ошибка


### Страница регистрации
Содержит 4 поля для ввода (логин, почта и пароль с подтверждением), чекбокс принятия условий,
а так же кнопку регистрации. Почта используется только для информационных целей, отправки писем или подтверждение
регистрации через письмо на почту не предусмотрено.

У всех полей присутствует валидация.

По нажатию на кнопку регистрации - проверяет введенные данные, и, если они верны - пропускает на главную страничку,
иначе выдает ошибку.

Регистрицаия должна работать корректно, а именно:
* все поля должны валидироваться
* в случае успеха новый пользователь добавляется в БД
* в случае неуспеха пользователь не добавляется в БД и выдается ошибка


### Главная страница
Содержит меню, информацию о текущем пользователе, различные ссылки на сторонние ресурсы и кнопку Logout.

Главная страница должна корректно работать, а именно:
* все ссылки должны вести в правильные ресурсы
* информация о текущем пользователе корректно отображается в правом верхем углу
* если у пользователя удалось получить VK ID, то данный идентификатор отображается аналогично в правом верхнем углу
* в нижней части страницы отображатеся случайный мотивационный факт о python
* кнопка Logout должна успешно разлогинивать пользователя



## Конфигурация приложения
Приложение требует указание конфиг файла через опцию `--config=<path/to/config>`.

Конфиг файл имеет обязательные и необязательные параметры.

Все опции в конфиг файле задаются в формате `KEY = VALUE`.

Поддерживаемые опции:
* Опционально:
    * `APP_HOST = '<app_host>'` # хост, на котором будет запущено приложение ('0.0.0.0' default)
    * `APP_PORT = '<app_port>'` # порт, на котором будет запущено приложение ('8080' default)
    * `MYSQL_HOST = '<mysql_host>'` # хост mysql, к которому будет подключаться приложение ('localhost' default)
    * `MYSQL_PORT = '<mysql_port>'` # порт mysql, к которому будет подключаться приложение ('3306' default)
    * `MYSQL_DB = '<mysql_db_name>'` # имя базы, к которой будет подключаться приложение ('technoatom' default)
* Обязательно
    * `VK_URL = '<vk_url_host>:<vk_url_port>'` # хост и порт VK API,
    у которого приложение будет запрашивать VK ID пользователя


## Описание базы данных
* БД должна работать и быть доступна для приложения по `mysql://MYSQL_HOST:MYSQL_PORT/MYSQL_DB`
* `MYSQL_DB` должна быть создана до старта приложения
* В БД присутстсует единственная таблица `test_users` следующего формата
```mysql
CREATE TABLE `test_users` (
  `id` int NOT NULL AUTO_INCREMENT,
  `username` varchar(16) DEFAULT NULL,
  `password` varchar(255) NOT NULL,
  `email` varchar(64) NOT NULL,
  `access` smallint DEFAULT NULL,
  `active` smallint DEFAULT NULL,
  `start_active_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `email` (`email`),
  UNIQUE KEY `ix_test_users_username` (`username`)
)
```

* Описание полей
    * `id` - идентификатор пользователя
    * `username` - имя пользователя, не может повторяться
    * `password` - пароль пользователя
    * `email` - почтовый адрес пользователя, не может повторяться
    * `access` - флаг доступа для пользователя (0|1)
    * `active` - флаг присутствия авторизационного пользователя на странице (0|1)
    * `start_active_time` - время последнего успешного входа пользователя
* Приложение может быть запущено с опцией `--setup`, которая выполняет инициализацию БД, самостоятельно создает схему
таблицу `test_users` и заполняет ее тестовыми данными. С данной опцией само приложение не запускается.
* Приложение работает с базой от пользователя `test_qa` с паролем `qa_test`.
* У данного пользователя должен быть доступ в базу `MYSQL_DB` и таблицу `test_users`.



## Логика работы приложения
* При успешной регистрации пользователя все регистрационные данные добавляются в таблицу `test_users`.
Флаг `access` по умолчанию выставляется в `1`.
* При неуспешной авторизации на странице отображаются корректные всплывающие сообщения с ошибками. Приложение
возвращает корректные HTTP коды ответа в случае ошибок.
* Доступ на главную страницу разршен пользователю, у которого поле `access` выставлено в `1`.
* Поле `access` проверяется на каждый запрос, если доступ запрещен - пользователь деавторизовывается.
* Любой вход пользователя на главную страницу проставляет поле `active` в `1`, а `start_active_time` во время входа.
* Любой выход пользователя проставляет поле `active` в `0`.


Всю отладочную информацию приложение выводит в stdout.


## Получение VK ID пользователя
* При запросе главной страницы приложение делает запрос в `VK_URL` для получения VK ID текущего пользователя и отображает
его в правом верхнем углу.
Если по каким то причинам получить идентификатор пользователя не удалось - VK ID не отображается.

* Формат запроса:

    * ```GET http://<VK_URL>/vk_id/<username>```, где
 
      * `VK_URL` - опция из конфига
      * `username` - текущий авторизованный пользователь


* Формат ожидаемого ответа:
    * Если пользователь найден
        ```http request
        Status: 200 OK
        Content-Type: application/json
        Response: {'vk_id': <vk_id>}
        ```
    * Если пользователь не найден
        ```http request
        Status: 404 Not Found
        Content-Type: application/json
        Response: {}
        ```

* Опция `VK_URL` обязательна в конфиге.
* Сервис должен работать до старта приложения.


## Описание API

На все запросы должно быть корректное сообщение/статус код.
* Сущность создана - код 201
* Сущность существует/не изменилась - код 304
* Сущность удалена - код 204
* Плохой запрос - код 400
* Сущности не существует - код 404
* Пользователь не авторизован - код 401
* Действие выполнено - код 200

Статус 500 недопустим. 

### Добавление пользователя
Формат запроса
```http request
POST http://<APP_HOST>:<APP_PORT>/api/add_user
Content-Type: application/json
Body:
{
   "username": "<username>", 
   "password": "<password>", 
   "email": "<email>"
}
```

* Поля должны валидироваться аналогично форме регистрации.
* В случае успеха пользователь добавляется в БД.


### Удаление пользователя
Формат запроса
```http request
GET http://<APP_HOST>:<APP_PORT>/api/del_user/<username>
```
* В случае успеха пользователь удаляется из БД.


### Блокировка пользователя
Формат запроса 
```http request
GET http://<APP_HOST>:<APP_PORT>/api/block_user/<username>
```
* В случае успеха пользователю проставляется `access` = `0` в БД.


### Разблокировка пользователя
Формат запроса 
```http request
GET http://<APP_HOST>:<APP_PORT>/api/accept_user/<username>
```
* В случае успеха пользователю проставляется `access` = `1` в БД.



### Статус приложения
Формат запроса 
```http request
GET http://<APP_HOST>:<APP_PORT>/status
```

Формат ответа
```http request
Status: 200 OK
Content-Type: application/json
Body:
{
    "status": "ok"
}
```
* Сигнализирует о том, что приложение запустилось и готово к работе.



## Пример запуска приложения
Вместе за заданием поставляется docker-образ myapp. Докер образ доступен по [ссылке](https://cloud.mail.ru/public/4nVm/5HGA3WEep)

Добавить скаченный образ в docker можно командой `docker load -i myapp`.

Так как приложение требует БД и поставщика VK ID, то необходимо их реализовать аналогично в докере, чтобы вся система заработала.

Последовательность действий:
* Запустить БД в отдельном контейнере
    * `MYSQL_CONTAINER_NAME` - произвольное имя контейнера с базой
    * `ROOT_PASSWORD` - произволный пароль для пользователя root
    * docker run --name `<MYSQL_CONTAINER_NAME>` -e MYSQL_ROOT_PASSWORD=`<ROOT_PASSWORD>` -p 3306:3306 -d mysql:latest
    
* Зайти в поднятую БД под пользователем root и паролем ROOT_PASSWORD
    * Создать произвольную базу данных `<DB_NAME>` 
    * Добавить пользователя `test_qa` с парлем `qa_test` и дать ему необходимые права на БД и таблицу.
* Написать mock-сервис для получения VK_API, собрать с ним docker-образ `vk_api` и запустить
    * `VK_API_CONTAINER_NAME` - произвольное имя контейнера с VK API
    * `VK_API_PORT` - произвольный порт, на котором поднят mock-сервис VK API
    * docker run --name `<VK_API_CONTAINER_NAME>` -p `<VK_API_PORT>:<VK_API_PORT>` -d vk_api:latest
* Создать произвольный конфиг файл `<CONFIG_FILE>` в произвольной директории `<PATH_TO_CONFIG>`, заполнить все поля:
    * APP_HOST = '0.0.0.0'
    * APP_PORT = `<APP_PORT>` - произвольный порт, на котором будет поднято приложение
    * MYSQL_HOST = `<MYSQL_DOCKER_HOSTNAME>` - имя контейнера с базой
    * MYSQL_PORT = 3306
    * MYSQL_DB = `<DB_NAME>` - имя созданной БД
    * VK_URL = `<VK_API_HOSTNAME>:<VK_API_PORT>`
* Запустить приложение из приложенного к заданию образа myapp:
    * `<DOCKER_PATH_TO_CONFIG>` - директория внутри контейнера, куда будет маунтиться `<PATH_TO_CONFIG>`
    * `<APP_PORT>` - порт приложения, указанный в конфиге
    * `<MYSQL_CONTAINER_NAME>` - имя контейнера с базой
    * `<MYSQL_DOCKER_HOSTNAME>` - hostname базы, который будет доступен внутри докера при линковке
    * `<VK_API_CONTAINER_NAME>` - имя контейнера с VK API
    * `<VK_API_HOSTNAME>` - hostname VK API, который будет доступен внутри докера при линковке
    * docker run -v `<PATH_TO_CONFIG>`:`<DOCKER_PATH_TO_CONFIG>` -p `<APP_PORT>`:`<APP_PORT>` 
    --link `<MYSQL_CONTAINER_NAME>`:`<MYSQL_DOCKER_HOSTNAME>` 
    --link `<VK_API_CONTAINER_NAME>`:`<VK_API_HOSTNAME>`
    myapp /app/myapp --config=`<DOCKER_PATH_TO_CONFIG>/<CONFIG_FILE>`
    
    
После всех выполненных действий появится возможность зайти на веб-приложение из браузера по `http:<APP_HOST>:<APP_PORT>`
и проводить тестирование.



## Тестирование
Конкретные задания на тестирование отсутствуют. Для студентов приложение является серым ящиком: у него есть подробное описание,
можно получать и менять данные в базе, смотреть логи, исходников приложения нет.

Необходимо комплексно протестировать приложение и предоставить отчет о проведенном тестировании:
* форма авторизации
* форма регистрации
* главная страница
* API


* Тест-кейсы составляются студентом самостоятельно исходя из навыков тестдизайна.
* Что и как тестировать полностью отдается под ответственность студента.
* Разрешается выполнять абсолютно любые операции, даже не указанные в описании.
* Если приложение работает не так как ожидается из описания - тест должен упасть и предоставить отладочную информацию.
* Если какое-либо поведение не указано в описании, но по мнению студента работает не так как должно - тест должен упасть
и предоставить причину падения.
* Каждый тест должен в docstring иметь описание, а именно:
    * что он тестирует
    * шаги выполнения
    * ожидаемый результат


## DevOps
Как именно будет подниматься приложение и все зависимости, а так же как будут запускаться тесты - полностью решает студент.

Запускать приложение вне докер образа myapp не допускается. Все остальное по желанию студента.



# Критерии оценки
Всего за итоговое задание можно максимально получить 57 баллов.


## Оценка части с тестированием (максимум 30 баллов)
* необходимо и достаточно покрыта форма авторизации - 2 балла
* необходимо и достаточно покрыта форма регистрации - 3 балла
* необходимо и достаточно покрыта главная страница - 2 балла
* необходимо и достаточно покрыто API - 3 балла
* присутствуют негативные тесты на все объекты тестирования - 4 балла
* нет избыточного тестирования, нет избыточных действий - 2 балла
* применены паттерны (fixtures, PageObject, APIObject, ORM итд) рассмотренные на лекции в течении курса - 2 балла
* найдены все заложенные в приложение баги (10 штук) - 3 балла
* найдены дополнительные баги, не заложенные в приложение - 2 балла
* реализован VK API mock с возможностью добавлять данные из тестов - 4 балла
* тесты предоставляют информативный отчет в allure со скриншотами, запросами/ответами, логами приложения - 2 балла
* тесты запускаются параллельно и не конфликтуют - 1 балл


## Оценка части с DevOps (максимум 27 баллов)
* написан docker образ в VK API - 5 баллов
* реализован один из вариантов запуска:
    * система запускается как указано в примере, selenoid запускается руками, тесты запускаются руками - 5 баллов
    * система запускается и завершается через docker-compose, selenoid запускается руками, тесты запускаются руками - 10 баллов
    * тесты запускаются руками, selenoid запускается руками, система запускается и завершается прямо из тестов - 15 баллов
    * тесты запускаются на Jenkins - 22 балла
        * подготовлена сборка
        * запускается selenoid
        * запускается система
        * запускаются тесты
        * система завершается
        * selenoid завершается
        * создается отчет в allure, который аттачится к сборке
        
        
Студент вправе реализовать собственный вариант запуска (оценивается отдельно, максимум 27 баллов)



# Сроки и условия выполнения задания
* Студенты получают задание 06.05.2020
* Студенты выполняют и показывают свой итоговый проект локально на своих ПК
* Код итогового проекта не заливается в репозитории до выставления оценки за итоговый проект
* Студенты проходят предзащиту 18.05.2020, где по очереди индивидуально показывают свою реализацию,
задают свои вопросы и получают замечания/комментарии
* Студенты индивидуально защищают свой проект 27.05.2020, демонстрируя что и как было сделано, предоставляют отчет о тестировании.
* До 29.05.2020 преподаватели обязаны выставить оценки за итоговый проект и объявить результаты.
* При успешной защите студент заливает код проекта на github.